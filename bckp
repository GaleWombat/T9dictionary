#include <iostream>
#include <string>
#include <vector>
#include <SFML/Graphics.hpp>
#include <SFML/System.hpp>

using namespace std;
using namespace sf;

const int cell_size_x = 300;
const int cell_size_y = 675;
const int button_size_x = cell_size_x/3;
const int button_size_y = cell_size_y/9;
const int textBox_size_x = cell_size_x*0.9;
const int textBox_size_y = cell_size_y*0.4;

const Color BLACK = Color(255,255,255);

Font cellFont;

class CellButton{
    public:
    CellButton(int top_left_x, int top_left_y, string text, int letters_capitacy);
    RectangleShape& getButton() {return cell_button;};
    void draw_button(RenderWindow& phone_window);
    void set_on_press(RenderWindow& phone_window) {cell_button.setFillColor(Color(30,30,200)); buttonText.setFillColor(Color::White); draw_button(phone_window);};
    void set_on_release(RenderWindow& phone_window) {cell_button.setFillColor(Color::White); buttonText.setFillColor(Color::Black); draw_button(phone_window);};
    int get_top_left_x() {return top_left_x;};
    int get_top_left_y() {return top_left_y;};
    string text_as_string;
    private:
    int top_left_x;
    int top_left_y;
    int letters_capitacy;
    Text buttonText;
    
    RectangleShape cell_button;
};

CellButton::CellButton(int top_left_x, int top_left_y, string text, int letters_capitacy): top_left_x(top_left_x), top_left_y(top_left_y), letters_capitacy(letters_capitacy){
    cell_button.setSize(Vector2f(button_size_x,button_size_y));
    cell_button.setFillColor(Color::White);
    cell_button.setOutlineThickness(1);
    cell_button.setOutlineColor(Color::Black);
    cell_button.setPosition(Vector2f(top_left_x,top_left_y));

    buttonText.setFont(cellFont); // <- here occures segmentation fault
    buttonText.setCharacterSize(16);
    buttonText.setStyle(Text::Regular);
    buttonText.setString(text);
    buttonText.setFillColor(Color::Black);
    buttonText.setPosition(Vector2f(top_left_x+(button_size_x/2)-16,top_left_y+(button_size_y/2)-16));
    text_as_string = text;
    cout<<text<<" range: "<<endl<<"x: "<<top_left_x<<" -> "<<top_left_x+button_size_x<<endl<<"y: "<<top_left_y<<" -> "<<top_left_y+button_size_y<<endl;
}
void CellButton::draw_button(RenderWindow& phone_window){
    phone_window.draw(cell_button);
    phone_window.draw(buttonText);
   
}

class CellKeyboard{
    public:
        CellKeyboard(int top_left_x = 0, int top_left_y = cell_size_y/2);
        void draw_keyboard(RenderWindow& phone_window);
        int get_top_left_x() {return top_left_x;};
        int get_top_left_y() {return top_left_y;};
        void set_button_on_press(int mouse_x, int mouse_y, RenderWindow& phone_window);
        void set_button_on_release(int mouse_x, int mouse_y, RenderWindow& phone_window);
    private:
        int top_left_x;
        int top_left_y;
        vector<CellButton> buttons;
};

CellKeyboard::CellKeyboard(int top_left_x , int top_left_y ): top_left_x(top_left_x), top_left_y(top_left_y){
    int current_x = top_left_x;
    int current_y = top_left_y;
    string current_letters = "";
    int letters_capitacy = 0;
    for(int i = 1; i < 13; i++){
        switch(i){
            case 1: current_letters = "1";break;
            case 2: current_letters = "2 ABC"; letters_capitacy = 3; break;
            case 3: current_letters = "3 DEF"; letters_capitacy = 3; break;
            case 4: current_letters = "4 GHI"; letters_capitacy = 3; break;
            case 5: current_letters = "5 JKL"; letters_capitacy = 3; break;
            case 6: current_letters = "6 MNO"; letters_capitacy = 3; break;
            case 7: current_letters = "7 PQRS"; letters_capitacy = 4; break;
            case 8: current_letters = "8 TUV"; letters_capitacy = 3; break;
            case 9: current_letters = "9 WXYZ"; letters_capitacy = 4; break;
            case 10: current_letters = "*";break;
            case 11:current_letters = "0 _"; letters_capitacy = 1; break;
            case 12:current_letters = "#";break;
        }
            
        CellButton newButton = CellButton(current_x,current_y,current_letters,letters_capitacy);
        buttons.push_back(newButton); 
        if(i%3==0){
            current_x = 0;
            current_y+=75;
        }
        else current_x+=100;
    }
    cout<<"keyboard range: "<<endl<<"x: "<<top_left_x<<" -> "<<top_left_x+button_size_x*3<<endl<<"y: "<<top_left_y<<" -> "<<top_left_y+button_size_y*4<<endl;
}

void CellKeyboard::draw_keyboard(RenderWindow& phone_window){
    for(auto button: buttons) button.draw_button(phone_window);
    // phone_window.display();
}

void CellKeyboard::set_button_on_press(int mouse_x, int mouse_y,RenderWindow& phone_window){
    for(int x = 0; x < buttons.size(); x++){
        if(mouse_x>=buttons[x].get_top_left_x() && mouse_x<=buttons[x].get_top_left_x()+button_size_x && mouse_y >= buttons[x].get_top_left_y() && mouse_y<=buttons[x].get_top_left_y()+button_size_y){
            buttons[x].set_on_press(phone_window); 
            break;
        }
        
    }
    phone_window.display();
}

void CellKeyboard::set_button_on_release(int mouse_x, int mouse_y, RenderWindow& phone_window){
    for(int x = 0; x < buttons.size(); x++){
        if(mouse_x>=buttons[x].get_top_left_x() && mouse_x<=buttons[x].get_top_left_x()+button_size_x && mouse_y >= buttons[x].get_top_left_y() && mouse_y<=buttons[x].get_top_left_y()+button_size_y){
            buttons[x].set_on_release(phone_window); 
            break;
        }
    }
    phone_window.display();
}

class CellTextBox{
    public:
    CellTextBox(int top_left_x = 50, int top_left_y = 50);
    void updateText(string appednigText) {textToPrint_as_string+=appednigText;textToPrint.setString(textToPrint_as_string);};
    void draw_textBox(RenderWindow& phone_window);
    private:
    int top_left_x;
    int top_left_y;
    RectangleShape textBox;
    string textToPrint_as_string = "";
    Text textToPrint;
};

CellTextBox::CellTextBox(int top_left_x, int top_left_y): top_left_x(top_left_x), top_left_y(top_left_y){
    textBox.setPosition(Vector2f(top_left_x,top_left_y));
    textBox.setSize(Vector2f(textBox_size_x,textBox_size_y));
    textBox.setFillColor(Color::White);
    textBox.setOutlineThickness(5);
    textBox.setOutlineColor(Color::Black);
    textToPrint.setFont(cellFont);
    textToPrint.setCharacterSize(24);
    textToPrint.setFillColor(Color::Black);
    textToPrint.setPosition(Vector2f(top_left_x,top_left_y));
}

void CellTextBox::draw_textBox(RenderWindow& phone_window){
    phone_window.draw(textBox);
    phone_window.draw(textToPrint);
    
}



void draw_cell_phone(RenderWindow& phone_window){
    phone_window.clear(Color::Cyan);
    // phone_window.display();
}

void draw_dictionary(RenderWindow& dictionary_window){
    dictionary_window.clear(Color::White);
    dictionary_window.display();
}

int main(){
    RenderWindow cell_phone(VideoMode(cell_size_x,cell_size_y), "Nukja");
    cellFont.loadFromFile("./tiff/PoiretOne-Regular.ttf");
    RenderWindow dictionary(VideoMode(300,300), "Dictionary");
    CellKeyboard k_brd(0,325);
    CellTextBox txt_bx(15,10);
    txt_bx.updateText("Hello World!");
    // CellButton btn(100,100,"TEST");
    Event event;
    while(cell_phone.isOpen()){
        while (cell_phone.pollEvent(event)){
            if (event.type == Event::Closed) cell_phone.close();
            if (event.type == Event::MouseMoved){
                // cout<<"new pos:"<<event.mouseMove.x<<", "<<event.mouseMove.y<<endl;
            }
            if (event.type == Event::MouseButtonPressed){
                if(event.mouseButton.button == Mouse::Left){
                    int mouse_x = event.mouseButton.x;
                    int mouse_y = event.mouseButton.y;
                    // cout<<"button clicked at: "<<mouse_x<<", "<<mouse_y<<endl;
                    // cout<<"RANGE: "<<endl<<"x: "<<k_brd.get_top_left_x()<<" -> "<<k_brd.get_top_left_x()+button_size_x*3<<endl<<"y: "<<k_brd.get_top_left_y()<<" -> "<<k_brd.get_top_left_y()+button_size_y*4<<endl;
                    if(mouse_x>=k_brd.get_top_left_x() && mouse_x<=k_brd.get_top_left_x()+button_size_x*3 && mouse_y >= k_brd.get_top_left_y() && mouse_y<=k_brd.get_top_left_y()+button_size_y*4){
                        // cout<<"clicked at: "<<mouse_x<<", "<<mouse_y<<endl;
                        k_brd.set_button_on_press(mouse_x, mouse_y, cell_phone);
                    }
                }
            }
            if(event.type == Event::MouseButtonReleased){
                if(event.mouseButton.button == Mouse::Left){
                    int mouse_x = event.mouseButton.x;
                    int mouse_y = event.mouseButton.y;
                    // cout<<"button realesed at: "<<mouse_x<<", "<<mouse_y<<endl;
                    
                    if(mouse_x>=k_brd.get_top_left_x() && mouse_x<=k_brd.get_top_left_x()+button_size_x*3 && mouse_y >= k_brd.get_top_left_y() && mouse_y<=k_brd.get_top_left_y()+button_size_y*4){
                        // cout<<"released at: "<<mouse_x<<", "<<mouse_y<<endl;
                        k_brd.set_button_on_release(mouse_x, mouse_y, cell_phone);
                    }  
                }
            }
        }
        while (dictionary.pollEvent(event)){
            if (event.type == Event::Closed) dictionary.close();
        }
        cell_phone.clear(Color(130,130,160));
        // btn.draw_self(cell_phone);
        k_brd.draw_keyboard(cell_phone);
        txt_bx.draw_textBox(cell_phone);
        cell_phone.display();
        // cell_phone.display();
        draw_dictionary(dictionary);
    }
}